// ==UserScript==
// @name        è‡ªåŠ¨å¤åˆ¶é€‰ä¸­æ–‡æœ¬å’Œè§£é™¤å¤åˆ¶é™åˆ¶æŒ‰é’®
// @name:zh     è‡ªåŠ¨å¤åˆ¶é€‰ä¸­æ–‡æœ¬å’Œè§£é™¤å¤åˆ¶é™åˆ¶æŒ‰é’®
// @name:en     Automatic Copy Selected Text and Remove Copy Restrictions Button
// @namespace   http://tampermonkey.net/
// @version     2.3
// @description åœ¨ä»»æ„ç½‘ç«™é€‰ä¸­ä»»æ„æ–‡æœ¬æ—¶è‡ªåŠ¨å¤åˆ¶ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæŒ‰é’®ä»¥å¯ç”¨/ç¦ç”¨è§£é™¤ç½‘ç«™çš„å¤åˆ¶é™åˆ¶å’Œè‡ªåŠ¨å¤åˆ¶åŠŸèƒ½
// @description:en Automatically copy selected text on any website and add a button to enable/disable unlocking copy restrictions and auto-copy functionality
// @author      lbihhe
// @license     MIT
// @match       *://*/*
// @grant       none
// @downloadURL https://update.greasyfork.org/scripts/497808/%E8%87%AA%E5%8A%A8%E5%A4%8D%E5%88%B6%E9%80%89%E4%B8%AD%E6%96%87%E6%9C%AC%E5%92%8C%E8%A7%A3%E9%99%A4%E5%A4%8D%E5%88%B6%E9%99%90%E5%88%B6%E6%8C%89%E9%92%AE.user.js
// @updateURL https://update.greasyfork.org/scripts/497808/%E8%87%AA%E5%8A%A8%E5%A4%8D%E5%88%B6%E9%80%89%E4%B8%AD%E6%96%87%E6%9C%AC%E5%92%8C%E8%A7%A3%E9%99%A4%E5%A4%8D%E5%88%B6%E9%99%90%E5%88%B6%E6%8C%89%E9%92%AE.meta.js
// ==/UserScript==

(function() {
    'use strict';

    // å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥å­˜å‚¨çŠ¶æ€å’ŒæŒ‰é’®
    var copyState = {
        enabled: false,
        button: createButton(),
        settings: {
            copyFormat: 'text',// å¤åˆ¶æ ¼å¼: text, html, link
            showAlert: true,// æ˜¯å¦æ˜¾ç¤ºæç¤ºä¿¡æ¯
            autoEnable: false// æ˜¯å¦è‡ªåŠ¨å¯ç”¨è„šæœ¬
        }
    };

    // åˆ›å»ºæŒ‰é’®
    function createButton() {
        var button = document.createElement('button');
        button.innerHTML = 'è§£é™¤å¤åˆ¶é™åˆ¶å¹¶å¯ç”¨è‡ªåŠ¨å¤åˆ¶';
        button.style.position = 'fixed';
        button.style.bottom = '20px';
        button.style.right = '20px';
        button.style.zIndex = '9999';
        button.style.padding = '10px 15px';
        button.style.backgroundColor = 'rgba(173, 216, 230, 0.9)';
        button.style.color = '#000';
        button.style.border = 'none';
        button.style.borderRadius = '10px';
        button.style.cursor = 'pointer';
        button.style.fontFamily = 'å¾®è½¯é›…é»‘, Arial, sans-serif';
        button.style.fontSize = '14px';
        button.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        button.style.transition = 'background-color 0.3s, transform 0.3s';
        button.onmouseover = function() {
            button.style.backgroundColor = 'rgba(135, 206, 235, 0.9)';
            button.style.transform = 'scale(1.05)';
        };
        button.onmouseout = function() {
            button.style.backgroundColor = 'rgba(173, 216, 230, 0.9)';
            button.style.transform = 'scale(1)';
        };
        var icon = document.createElement('span');
        icon.innerHTML = 'ğŸ”“';
        icon.style.marginRight = '8px';
        button.prepend(icon);
        document.body.appendChild(button);
        return button;
    }

    // åœæ­¢äº‹ä»¶ä¼ æ’­çš„å¤„ç†å‡½æ•°
    function stopPropagation(e) {
        e.stopPropagation();
    }

    // è‡ªåŠ¨å¤åˆ¶é€‰ä¸­æ–‡æœ¬çš„å¤„ç†å‡½æ•°
    function autoCopyHandler() {
        if (copyState.enabled) {
            var selectedText = window.getSelection().toString().trim();
            if (selectedText) {
                if (copyState.settings.copyFormat === 'text') {
                    copyTextToClipboard(selectedText);
                } else if (copyState.settings.copyFormat === 'html') {
                    copyHTMLToClipboard(selectedText);
                } else if (copyState.settings.copyFormat === 'link') {
                    var url = window.location.href;
                    copyTextToClipboard(`${selectedText}\n${url}`);
                }
            }
        }
    }

    // å°†æ–‡æœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyTextToClipboard(text) {
        var tempTextarea = document.createElement('textarea');
        tempTextarea.style.position = 'fixed';
        tempTextarea.style.top = '0';
        tempTextarea.style.left = '0';
        tempTextarea.style.width = '2em';
        tempTextarea.style.height = '2em';
        tempTextarea.style.padding = '0';
        tempTextarea.style.border = 'none';
        tempTextarea.style.outline = 'none';
        tempTextarea.style.boxShadow = 'none';
        tempTextarea.style.background = 'transparent';
        tempTextarea.value = text;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                showAlert('é€‰ä¸­æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } else {
                showAlert('å¤åˆ¶å¤±è´¥');
            }
        } catch (err) {
            showAlert('å¤åˆ¶è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: ' + err);
        }
        document.body.removeChild(tempTextarea);
    }

    // å°† HTML å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyHTMLToClipboard(html) {
        var tempDiv = document.createElement('div');
        tempDiv.style.position = 'fixed';
        tempDiv.style.top = '0';
        tempDiv.style.left = '0';
        tempDiv.style.width = '2em';
        tempDiv.style.height = '2em';
        tempDiv.style.padding = '0';
        tempDiv.style.border = 'none';
        tempDiv.style.outline = 'none';
        tempDiv.style.boxShadow = 'none';
        tempDiv.style.background = 'transparent';
        tempDiv.innerHTML = html;
        document.body.appendChild(tempDiv);
        var range = document.createRange();
        range.selectNodeContents(tempDiv);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                showAlert('é€‰ä¸­çš„ HTML å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } else {
                showAlert('å¤åˆ¶ HTML å¤±è´¥');
            }
        } catch (err) {
            showAlert('å¤åˆ¶ HTML è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: ' + err);
        }
        document.body.removeChild(tempDiv);
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(message) {
        if (copyState.settings.showAlert) {
            var alertBox = document.createElement('div');
            alertBox.innerText = message;
            alertBox.style.position = 'fixed';
            alertBox.style.bottom = '70px';
            alertBox.style.right = '20px';
            alertBox.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            alertBox.style.color = '#fff';
            alertBox.style.padding = '10px 15px';
            alertBox.style.borderRadius = '10px';
            alertBox.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            alertBox.style.fontFamily = 'å¾®è½¯é›…é»‘, Arial, sans-serif';
            alertBox.style.fontSize = '14px';
            alertBox.style.zIndex = '9999';
            document.body.appendChild(alertBox);
            setTimeout(function() {
                document.body.removeChild(alertBox);
            }, 3000);
        }
    }

    // è§£é™¤å¤åˆ¶é™åˆ¶çš„å‡½æ•°
    function enableCopy() {
        // ç§»é™¤å¸¸è§çš„ç¦æ­¢å¤åˆ¶çš„äº‹ä»¶ç›‘å¬å™¨
        ['copy', 'cut', 'contextmenu', 'selectstart', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress', 'oncopy', 'oncut', 'onpaste'].forEach(event => {
            document.addEventListener(event, stopPropagation, true);
        });

        // è§£é™¤ CSS æ ·å¼é™åˆ¶
        var css = `
            * {
                -webkit-user-select: auto !important;
                -moz-user-select: auto !important;
                -ms-user-select: auto !important;
                user-select: auto !important;
                pointer-events: auto !important;
                -webkit-touch-callout: default !important;
            }
        `;
        var style = document.createElement('style');
        style.type = 'text/css';
        style.appendChild(document.createTextNode(css));
        document.head.appendChild(style);

        // å¤„ç† body æ ‡ç­¾çš„ oncontextmenu å±æ€§
        if (document.body) {
            document.body.oncontextmenu = null;
        }

        // å¤„ç†å¸¸è§çš„æ¡†æ¶
        var frames = [...document.getElementsByTagName('iframe'), ...document.getElementsByTagName('object'), ...document.getElementsByTagName('embed')];
        frames.forEach(frame => {
            try {
                var frameDoc = frame.contentWindow.document;
                ['copy', 'cut', 'contextmenu', 'selectstart', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress'].forEach(event => {
                    frameDoc.addEventListener(event, stopPropagation, true);
                });
            } catch (e) {
                console.error('æ— æ³•è®¿é—®æ¡†æ¶å†…å®¹:', e);
            }
        });

        // æ·»åŠ é¼ æ ‡æŠ¬èµ·äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('mouseup', autoCopyHandler, true);
    }

    // ç¦ç”¨å¤åˆ¶åŠŸèƒ½çš„å‡½æ•°
    function disableCopy() {
        // æ¢å¤é»˜è®¤äº‹ä»¶
        ['copy', 'cut', 'contextmenu', 'selectstart', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress', 'oncopy', 'oncut', 'onpaste'].forEach(event => {
            document.removeEventListener(event, stopPropagation, true);
        });

        // ç§»é™¤ CSS æ ·å¼é™åˆ¶
        var style = document.querySelector('style');
        if (style) {
            document.head.removeChild(style);
        }

        // æ¢å¤é»˜è®¤ body æ ‡ç­¾çš„ oncontextmenu å±æ€§
        if (document.body) {
            document.body.oncontextmenu = null;
        }

        // ç§»é™¤é¼ æ ‡æŠ¬èµ·äº‹ä»¶ç›‘å¬å™¨
        document.removeEventListener('mouseup', autoCopyHandler, true);
    }

    // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - å¯ç”¨/ç¦ç”¨è§£é™¤å¤åˆ¶é™åˆ¶å’Œè‡ªåŠ¨å¤åˆ¶
    copyState.button.addEventListener('click', function() {
        if (copyState.enabled) {
            disableCopy();
            copyState.button.innerHTML = 'è§£é™¤å¤åˆ¶é™åˆ¶å¹¶å¯ç”¨è‡ªåŠ¨å¤åˆ¶';
            copyState.button.querySelector('span').innerHTML = 'ğŸ”“';
        } else {
            enableCopy();
            copyState.button.innerHTML = 'ç¦ç”¨å¤åˆ¶åŠŸèƒ½';
            copyState.button.querySelector('span').innerHTML = 'ğŸ”’';
        }
        copyState.enabled = !copyState.enabled;
    });

    // è‡ªåŠ¨å¯ç”¨åŠŸèƒ½
    if (copyState.settings.autoEnable) {
        enableCopy();
        copyState.enabled = true;
        copyState.button.innerHTML = 'ç¦ç”¨å¤åˆ¶åŠŸèƒ½';
        copyState.button.querySelector('span').innerHTML = 'ğŸ”’';
    }
})();
