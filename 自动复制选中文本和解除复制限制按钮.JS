// ==UserScript==
// @name        è‡ªåŠ¨å¤åˆ¶é€‰ä¸­æ–‡æœ¬å’Œè§£é™¤å¤åˆ¶é™åˆ¶
// @name:zh-CN  è‡ªåŠ¨å¤åˆ¶é€‰ä¸­æ–‡æœ¬å’Œè§£é™¤å¤åˆ¶é™åˆ¶
// @name:zh-TW  è‡ªå‹•è¤‡è£½é¸ä¸­æ–‡æœ¬å’Œè§£é™¤è¤‡è£½é™åˆ¶
// @name:en     Auto Copy Selected Text and Remove Copy Restrictions
// @name:ja     é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•ã‚³ãƒ”ãƒ¼ã—ã€ã‚³ãƒ”ãƒ¼åˆ¶é™ã‚’è§£é™¤
// @name:ko     ì„ íƒí•œ í…ìŠ¤íŠ¸ ìë™ ë³µì‚¬ ë° ë³µì‚¬ ì œí•œ í•´ì œ
// @description  åœ¨ä»»æ„ç½‘ç«™é€‰ä¸­ä»»æ„æ–‡æœ¬æ—¶è‡ªåŠ¨å¤åˆ¶, å¹¶æä¾›è®¾ç½®é€‰é¡¹ä»¥å¯ç”¨/ç¦ç”¨è§£é™¤ç½‘ç«™çš„å¤åˆ¶é™åˆ¶å’Œè‡ªåŠ¨å¤åˆ¶åŠŸèƒ½, ä»¥åŠæ˜¾ç¤º/éšè—æŒ‰é’®
// @description:zh-CN  åœ¨ä»»æ„ç½‘ç«™é€‰ä¸­ä»»æ„æ–‡æœ¬æ—¶è‡ªåŠ¨å¤åˆ¶, å¹¶æä¾›è®¾ç½®é€‰é¡¹ä»¥å¯ç”¨/ç¦ç”¨è§£é™¤ç½‘ç«™çš„å¤åˆ¶é™åˆ¶å’Œè‡ªåŠ¨å¤åˆ¶åŠŸèƒ½, ä»¥åŠæ˜¾ç¤º/éšè—æŒ‰é’®
// @description:zh-TW  åœ¨ä»»ä½•ç¶²ç«™é¸ä¸­ä»»æ„æ–‡æœ¬æ™‚è‡ªå‹•è¤‡è£½, ä¸¦æä¾›è¨­ç½®é¸é …ä»¥å•Ÿç”¨/ç¦ç”¨è§£é™¤ç¶²ç«™çš„è¤‡è£½é™åˆ¶å’Œè‡ªå‹•è¤‡è£½åŠŸèƒ½, ä»¥åŠé¡¯ç¤º/éš±è—æŒ‰éˆ•
// @description:en     Automatically copy selected text on any website and provide options to enable/disable removal of copy restrictions and auto copy functionality, as well as show/hide button
// @description:ja     ä»»æ„ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•çš„ã«ã‚³ãƒ”ãƒ¼ã—ã€ã‚³ãƒ”ãƒ¼åˆ¶é™ã®è§£é™¤ã¨è‡ªå‹•ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹ã€è¡¨ç¤º/éè¡¨ç¤ºãƒœã‚¿ãƒ³ã®è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™
// @description:ko     ëª¨ë“  ì›¹ì‚¬ì´íŠ¸ì—ì„œ ì„ íƒí•œ í…ìŠ¤íŠ¸ë¥¼ ìë™ ë³µì‚¬í•˜ë©°, ì›¹ì‚¬ì´íŠ¸ì˜ ë³µì‚¬ ì œí•œ í•´ì œ ë° ìë™ ë³µì‚¬ ê¸°ëŠ¥ í™œì„±í™”/ë¹„í™œì„±í™”, ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¸°ê¸° ì„¤ì • ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤
// @author       lbihhe
// @license      MIT
// @icon         https://img.icons8.com/nolan/64/password1.png
// @version      4.0
// @match        *://*/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @run-at       document-start
// @namespace    http://tampermonkey.net/
// @downloadURL https://update.greasyfork.org/scripts/497808/%E8%87%AA%E5%8A%A8%E5%A4%8D%E5%88%B6%E9%80%89%E4%B8%AD%E6%96%87%E6%9C%AC%E5%92%8C%E8%A7%A3%E9%99%A4%E5%A4%8D%E5%88%B6%E9%99%90%E5%88%B6.user.js
// @updateURL https://update.greasyfork.org/scripts/497808/%E8%87%AA%E5%8A%A8%E5%A4%8D%E5%88%B6%E9%80%89%E4%B8%AD%E6%96%87%E6%9C%AC%E5%92%8C%E8%A7%A3%E9%99%A4%E5%A4%8D%E5%88%B6%E9%99%90%E5%88%B6.meta.js
// ==/UserScript==

/*!
MIT License

Copyright (c) [2024] [gura8390]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

(() => {
    'use strict';

    /*** å›½é™…åŒ–éƒ¨åˆ† ***/
    const userLang = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
    const language = userLang.startsWith('zh')
      ? 'zh'
      : userLang.startsWith('ja')
      ? 'ja'
      : userLang.startsWith('es')
      ? 'es'
      : 'en';

    const messages = {
        zh: {
            enableCopy: 'ğŸ”“è§£é™¤å¤åˆ¶é™åˆ¶å¹¶å¯ç”¨è‡ªåŠ¨å¤åˆ¶',
            disableCopy: 'ğŸ”’ç¦ç”¨å¤åˆ¶åŠŸèƒ½åŠå¤åˆ¶é™åˆ¶',
            copyTextAlert: 'é€‰ä¸­æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
            copyHTMLAlert: 'é€‰ä¸­çš„ HTML å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
            copyFailureAlert: 'å¤åˆ¶å¤±è´¥',
            copyExceptionAlert: 'å¤åˆ¶è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: ',
            invalidCopyFormatAlert: 'æ— æ•ˆçš„å¤åˆ¶æ ¼å¼ï¼Œä¿ç•™å½“å‰è®¾ç½®ã€‚',
            copyFormatPrompt: 'è¯·é€‰æ‹©å¤åˆ¶æ ¼å¼ï¼ˆtext: çº¯æ–‡æœ¬, html: HTML, link: é“¾æ¥å’Œæ–‡æœ¬ï¼‰:',
            toggleShowButton: 'è®¾ç½®æ˜¾ç¤º/éšè—è§£é™¤å¤åˆ¶é™åˆ¶æŒ‰é’®',
            setCopyFormat: 'è®¾ç½®å¤åˆ¶æ ¼å¼'
        },
        en: {
            enableCopy: 'ğŸ”“Enable Copy Restrictions and Auto Copy',
            disableCopy: 'ğŸ”’Disable Copy Restrictions and Auto Copy',
            copyTextAlert: 'Selected text copied to clipboard',
            copyHTMLAlert: 'Selected HTML copied to clipboard',
            copyFailureAlert: 'Copy failed',
            copyExceptionAlert: 'Exception during copy: ',
            invalidCopyFormatAlert: 'Invalid copy format, retaining current settings.',
            copyFormatPrompt: 'Please select copy format (text: Plain text, html: HTML, link: Link and text):',
            toggleShowButton: 'Toggle Show/Hide Copy Restrictions Button',
            setCopyFormat: 'Set Copy Format'
        },
        ja: {
            enableCopy: 'ğŸ”“ã‚³ãƒ”ãƒ¼åˆ¶é™ã‚’è§£é™¤ã—ã€è‡ªå‹•ã‚³ãƒ”ãƒ¼ã‚’æœ‰åŠ¹åŒ–',
            disableCopy: 'ğŸ”’ã‚³ãƒ”ãƒ¼åˆ¶é™ã¨è‡ªå‹•ã‚³ãƒ”ãƒ¼ã‚’ç„¡åŠ¹ã«ã™ã‚‹',
            copyTextAlert: 'é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ',
            copyHTMLAlert: 'é¸æŠã—ãŸHTMLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ',
            copyFailureAlert: 'ã‚³ãƒ”ãƒ¼å¤±æ•—',
            copyExceptionAlert: 'ã‚³ãƒ”ãƒ¼ä¸­ã«ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ',
            invalidCopyFormatAlert: 'ç„¡åŠ¹ãªã‚³ãƒ”ãƒ¼å½¢å¼ã§ã™ã€‚ç¾åœ¨ã®è¨­å®šã‚’ä¿æŒã—ã¾ã™ã€‚',
            copyFormatPrompt: 'ã‚³ãƒ”ãƒ¼å½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆtext: ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ, html: HTML, link: ãƒªãƒ³ã‚¯ã¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰:',
            toggleShowButton: 'ã‚³ãƒ”ãƒ¼åˆ¶é™ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿',
            setCopyFormat: 'ã‚³ãƒ”ãƒ¼å½¢å¼ã‚’è¨­å®š'
        },
        es: {
            enableCopy: 'ğŸ”“Habilitar restricciones de copia y auto-copia',
            disableCopy: 'ğŸ”’Deshabilitar restricciones de copia y auto-copia',
            copyTextAlert: 'Texto seleccionado copiado al portapapeles',
            copyHTMLAlert: 'HTML seleccionado copiado al portapapeles',
            copyFailureAlert: 'Error al copiar',
            copyExceptionAlert: 'ExcepciÃ³n durante la copia: ',
            invalidCopyFormatAlert: 'Formato de copia no vÃ¡lido, se mantienen los ajustes actuales.',
            copyFormatPrompt: 'Seleccione el formato de copia (text: Texto plano, html: HTML, link: Enlace y texto):',
            toggleShowButton: 'Alternar mostrar/ocultar botÃ³n de restricciones de copia',
            setCopyFormat: 'Establecer formato de copia'
        }
    };

    const t = key => (messages[language] && messages[language][key]) || messages.en[key];
    console.log(`å½“å‰è¯­è¨€: ${language}, æ˜¾ç¤ºæ–‡æœ¬:`, t('enableCopy'));

    /******** é’ˆå¯¹ç‰¹å®šç½‘ç«™ï¼ˆdoc88.comï¼‰çš„å¤„ç† ********/
    let doc88Path = "";
    const websiteRuleDoc88 = {
        regexp: /.*doc88\.com\/.+/,
        init: () => {
            const style = document.createElement('style');
            style.id = "copy-element-hide";
            style.textContent = "#left-menu{display: none !important;}";
            document.head.appendChild(style);

            GM_xmlhttpRequest({
                method: "GET",
                url: "https://res3.doc88.com/resources/js/modules/main-v2.min.js?v=2.56",
                onload: response => {
                    const result = /\("#cp_textarea"\).val\(([\S]*?)\);/.exec(response.responseText);
                    if (result) {
                        doc88Path = result[1];
                    }
                }
            });

            window.addEventListener("load", () => {
                const cpFn = unsafeWindow.copyText?.toString();
                const fnResult = cpFn && /<textarea[\s\S]*?>'\+([\S]*?)\+"<\/textarea>/.exec(cpFn);
                if (fnResult) {
                    doc88Path = fnResult[1];
                }
            });
        },
        getSelectedText: () => {
            let select = unsafeWindow;
            doc88Path.split(".").forEach(v => {
                select = select?.[v];
            });
            if (!select) {
                unsafeWindow.Config.vip = 1;
                unsafeWindow.Config.logined = 1;
                document.getElementById("copy-element-hide")?.remove();
            }
            return select;
        }
    };

    /******** é’ˆå¯¹ç™¾åº¦æ–‡åº“ï¼ˆwenku.baidu.comï¼‰çš„ç‰¹æ®Šä¼˜åŒ– ********/
    const websiteRuleWenku = {
        regexp: /wenku\.baidu\.com\/(view|link|aggs).*/,
        canvasDataGroup: [],
        init: function() {
            // æ·»åŠ æ‰“å°ç›¸å…³æ ·å¼ï¼ˆå¯é€‰ï¼‰
            const style = document.createElement("style");
            style.textContent = `@media print { body{ display:block; } }`;
            document.head.appendChild(style);

          // è·å– canvas çš„åŸå§‹ 2D ä¸Šä¸‹æ–‡åŸå‹
            const originObject = {
                context2DPrototype: Object.getPrototypeOf(unsafeWindow.document.createElement("canvas").getContext("2d"))
            };


            // åŠ«æŒ document.createElementï¼Œå½“åˆ›å»º canvas æ—¶è¦†ç›– fillText æ–¹æ³•ï¼Œæ•è·ç»˜åˆ¶æ–‡å­—
            document.createElement = new Proxy(document.createElement, {
                apply: function(target, thisArg, argumentsList) {
                    const element = Reflect.apply(target, thisArg, argumentsList);
                    if (argumentsList[0] === "canvas") {
                        const tmpData = {
                            canvas: element,
                            data: []
                        };
                        const context = element.getContext("2d");
                        const originalFillText = originObject.context2DPrototype.fillText;
                        context.fillText = function(...args) {
                            tmpData.data.push(args);
                            return originalFillText.apply(this, args);
                        };
                        websiteRuleWenku.canvasDataGroup.push(tmpData);
                    }
                    return element;
                }
            });

            // ä¼ªé€  VIP ä¿¡æ¯ï¼ŒåŠ«æŒå…¨å±€ pageData
            let pageData = {};
            Object.defineProperty(unsafeWindow, "pageData", {
                set: (v) => { pageData = v; },
                get: function() {
                    if (!pageData.vipInfo) pageData.vipInfo = {};
                    pageData.vipInfo.global_svip_status = 1;
                    pageData.vipInfo.global_vip_status = 1;
                    pageData.vipInfo.isVip = 1;
                    pageData.vipInfo.isWenkuVip = 1;
                    return pageData;
                }
            });

        },
        getSelectedText: function() {
            // å°è¯•ä»æ•è·çš„ canvas æ•°æ®ä¸­é‡æ„æ–‡æœ¬
            let text = "";
            if (this.canvasDataGroup.length > 0) {
                this.canvasDataGroup.forEach(item => {
                    item.data.forEach(args => {
                        text += args[0] + " ";
                    });
                });
                text = text.trim();
            }
            // å¦‚æœæ²¡æœ‰æ•è·åˆ°ï¼Œåˆ™é€€åŒ–ä¸ºæ­£å¸¸çš„é¡µé¢é€‰ä¸­å†…å®¹
            if (!text) {
                text = window.getSelection().toString().trim();
            }
            return text;
        }
    };

    // å¦‚æœå½“å‰é¡µé¢ä¸º doc88 æˆ–ç™¾åº¦æ–‡åº“ï¼Œåˆ™æ‰§è¡Œç›¸åº”åˆå§‹åŒ–
    if (websiteRuleDoc88.regexp.test(window.location.href)) {
        websiteRuleDoc88.init();
    }
    if (websiteRuleWenku.regexp.test(window.location.href)) {
        websiteRuleWenku.init();
        // ç™¾åº¦æ–‡åº“é¡µé¢ä¸éœ€è¦å³ä¸‹è§’å¤åˆ¶æŒ‰é’®ï¼ˆç›´æ¥æŠ›å¼ƒï¼‰
        // åç»­ autoCopyHandler ä¼šè°ƒç”¨ websiteRuleWenku.getSelectedText() æ¥è·å–æ–‡æœ¬
    }

/******** è¯»å–å­˜å‚¨çš„è®¾ç½® ********/
const copyState = {
    enabled: GM_getValue('enabled', false),
    showButton: GM_getValue('showButton', true),
    copyFormat: GM_getValue('copyFormat', 'text'),
    showAlert: GM_getValue('showAlert', true)
};

/******** å…¨å±€å˜é‡ ********/
let button = null; // æå‰å£°æ˜æŒ‰é’®å˜é‡

/******** å®šä¹‰åˆ‡æ¢å¤åˆ¶çŠ¶æ€çš„å‡½æ•° ********/
function toggleCopyState() {
    if (copyState.enabled) {
        disableCopy();
        if (button) button.innerHTML = t('enableCopy');
    } else {
        enableCopy();
        if (button) button.innerHTML = t('disableCopy');
    }
    copyState.enabled = !copyState.enabled;
    GM_setValue('enabled', copyState.enabled);
}

/******** å®šä¹‰å…¶ä»–å‡½æ•° ********/
const stopPropagation = e => e.stopPropagation();

// è‡ªåŠ¨å¤åˆ¶å¤„ç†ï¼šæ ¹æ®å½“å‰é¡µé¢åˆ†åˆ«è°ƒç”¨ç‰¹æ®Šå¤„ç†çš„è·å–æ–‡æœ¬æ–¹æ³•
const autoCopyHandler = () => {
    let selectedText = "";
    if (websiteRuleDoc88.regexp.test(window.location.href)) {
        selectedText = websiteRuleDoc88.getSelectedText();
    } else if (websiteRuleWenku.regexp.test(window.location.href)) {
        selectedText = websiteRuleWenku.getSelectedText();
    } else {
        selectedText = window.getSelection().toString().trim();
    }
    if (selectedText) {
        switch (copyState.copyFormat) {
            case 'text':
                copyTextToClipboard(selectedText);
                break;
            case 'html':
                copyHTMLToClipboard(selectedText);
                break;
            case 'link':
                copyTextToClipboard(`${selectedText}\n${window.location.href}`);
                break;
            default:
                copyTextToClipboard(selectedText);
                break;
        }
    }
};

const copyTextToClipboard = textContent => {
    const tempTextarea = document.createElement('textarea');
    Object.assign(tempTextarea.style, {
        position: 'fixed',
        top: '0',
        left: '0',
        width: '2em',
        height: '2em',
        padding: '0',
        border: 'none',
        outline: 'none',
        boxShadow: 'none',
        background: 'transparent'
    });
    tempTextarea.value = textContent;
    document.body.appendChild(tempTextarea);
    tempTextarea.select();
    try {
        const successful = document.execCommand('copy');
        showAlert(successful ? t('copyTextAlert') : t('copyFailureAlert'));
    } catch (err) {
        showAlert(t('copyExceptionAlert') + err);
    }
    document.body.removeChild(tempTextarea);
};

const copyHTMLToClipboard = htmlContent => {
    const tempDiv = document.createElement('div');
    Object.assign(tempDiv.style, {
        position: 'fixed',
        top: '0',
        left: '0',
        width: '2em',
        height: '2em',
        padding: '0',
        border: 'none',
        outline: 'none',
        boxShadow: 'none',
        background: 'transparent'
    });
    tempDiv.innerHTML = htmlContent;
    document.body.appendChild(tempDiv);
    const range = document.createRange();
    range.selectNodeContents(tempDiv);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    try {
        const successful = document.execCommand('copy');
        showAlert(successful ? t('copyHTMLAlert') : t('copyFailureAlert'));
    } catch (err) {
        showAlert(t('copyExceptionAlert') + err);
    }
    document.body.removeChild(tempDiv);
};

const showAlert = message => {
    if (!copyState.showAlert) return;
    const alertBox = document.createElement('div');
    alertBox.innerText = message;
    Object.assign(alertBox.style, {
        position: 'fixed',
        bottom: '70px',
        right: '20px',
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        color: '#fff',
        padding: '10px 15px',
        borderRadius: '10px',
        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontSize: '14px',
        zIndex: '9999'
    });
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
};

const enableCopy = () => {
    ['copy', 'cut', 'contextmenu', 'selectstart', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress', 'oncopy', 'oncut', 'onpaste']
        .forEach(event => document.addEventListener(event, stopPropagation, true));

    const style = document.createElement('style');
    style.type = 'text/css';
    style.textContent = `
        * {
            -webkit-user-select: auto !important;
            -moz-user-select: auto !important;
            -ms-user-select: auto !important;
            user-select: auto !important;
            pointer-events: auto !important;
            -webkit-touch-callout: default !important;
        }
    `;
    document.head.appendChild(style);

    if (document.body) {
        document.body.oncontextmenu = null;
    }

    const frames = [
        ...document.getElementsByTagName('iframe'),
        ...document.getElementsByTagName('object'),
        ...document.getElementsByTagName('embed')
    ];
    frames.forEach(frame => {
        try {
            const frameDoc = frame.contentWindow.document;
            ['copy', 'cut', 'contextmenu', 'selectstart', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress']
                .forEach(event => frameDoc.addEventListener(event, stopPropagation, true));
        } catch (e) {
            console.error('æ— æ³•è®¿é—®æ¡†æ¶å†…å®¹:', e);
        }
    });

    document.addEventListener('mouseup', autoCopyHandler, true);
};

const disableCopy = () => {
    ['copy', 'cut', 'contextmenu', 'selectstart', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress', 'oncopy', 'oncut', 'onpaste']
        .forEach(event => document.removeEventListener(event, stopPropagation, true));

    document.querySelectorAll('style').forEach(style => {
        if (style.textContent.includes('-webkit-user-select: auto !important')) {
            style.remove();
        }
    });
    document.removeEventListener('mouseup', autoCopyHandler, true);
};

function createButton() {
    // å¦‚æœæ˜¯ç™¾åº¦æ–‡åº“é¡µé¢ï¼Œåˆ™ä¸åˆ›å»ºæŒ‰é’®ï¼ˆç›´æ¥æŠ›å¼ƒï¼‰
    if (websiteRuleWenku.regexp.test(window.location.href)) {
        return null;
    }
    const btn = document.createElement('button');
    btn.innerHTML = t('enableCopy');
    Object.assign(btn.style, {
        position: 'fixed',
        bottom: '20px',
        right: '20px',
        zIndex: '9999',
        padding: '10px 15px',
        backgroundColor: 'rgba(173, 216, 230, 0.9)',
        color: '#000',
        border: 'none',
        borderRadius: '10px',
        cursor: 'pointer',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontSize: '14px',
        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
        transition: 'background-color 0.3s, transform 0.3s'
    });
    btn.addEventListener('mouseover', () => {
        btn.style.backgroundColor = 'rgba(135, 206, 235, 0.9)';
        btn.style.transform = 'scale(1.05)';
    });
    btn.addEventListener('mouseout', () => {
        btn.style.backgroundColor = 'rgba(173, 216, 230, 0.9)';
        btn.style.transform = 'scale(1)';
    });
    btn.addEventListener('click', toggleCopyState);
    return btn;
}

/******** èœå•å‘½ä»¤æ³¨å†Œ ********/
// åˆ‡æ¢æ˜¾ç¤º/éšè—æŒ‰é’®
GM_registerMenuCommand(t('toggleShowButton'), () => {
    copyState.showButton = !copyState.showButton;
    GM_setValue('showButton', copyState.showButton);
    if (copyState.showButton) {
        // å¦‚æœæŒ‰é’®ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦åˆ™å°†æŒ‰é’®æ·»åŠ åˆ° DOM ä¸­
        if (!button) {
            button = createButton();
            copyState.button = button;
        } else if (button && !document.contains(button)) {
            document.body.appendChild(button);
        }
    } else {
        button && button.parentNode && button.parentNode.removeChild(button);
    }
});

// è®¾ç½®å¤åˆ¶æ ¼å¼
GM_registerMenuCommand(t('setCopyFormat'), () => {
    const options = ['text', 'html', 'link'];
    const copyFormat = prompt(t('copyFormatPrompt'), copyState.copyFormat);
    if (options.includes(copyFormat)) {
        copyState.copyFormat = copyFormat;
        GM_setValue('copyFormat', copyState.copyFormat);
    } else {
        alert(t('invalidCopyFormatAlert'));
    }
});

/******** è„šæœ¬åˆå§‹åŒ– ********/
// å»¶è¿ŸæŒ‰é’®åˆ›å»ºï¼Œç¡®ä¿ DOM å·²åŠ è½½
if (copyState.showButton && !websiteRuleWenku.regexp.test(window.location.href)) {
    window.addEventListener('DOMContentLoaded', () => {
        // åˆ›å»ºå¹¶æ·»åŠ æŒ‰é’®åˆ°é¡µé¢
        if (!button) {
            button = createButton();
            copyState.button = button;
        }
        if (button && !document.body.contains(button)) {
            document.body.appendChild(button);
        }
    });
}

// åˆå§‹çŠ¶æ€ï¼šç¦ç”¨è‡ªåŠ¨å¤åˆ¶åŠŸèƒ½
disableCopy();

})();
